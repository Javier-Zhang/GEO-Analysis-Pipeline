---
title: "Microarray QC Report / 微阵列质控报告"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
params:
  gse_id: "Unknown"
  qc_results: NULL
  eset: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(ggplot2)
library(plotly)
library(DT)
library(pheatmap)
```

# 数据集信息 / Dataset Information

**GSE ID:** `r params$gse_id`

**分析日期 / Analysis Date:** `r Sys.Date()`

```{r dataset-info}
if (!is.null(params$eset)) {
  cat(sprintf("- 样本数 / Number of samples: %d\n", ncol(exprs(params$eset))))
  cat(sprintf("- 特征数 / Number of features: %d\n", nrow(exprs(params$eset))))
  cat(sprintf("- 平台 / Platform: %s\n", tryCatch(annotation(params$eset), error = function(e) "Unknown")))
}
```

# 质控摘要 / QC Summary

```{r qc-summary}
if (!is.null(params$qc_results)) {
  qc <- params$qc_results
  
  summary_df <- data.frame(
    Metric = c("样本数 / Samples", "异常样本数 / Outliers", 
               "平均相关性 / Mean Correlation", "PC1方差 / PC1 Variance"),
    Value = c(
      qc$summary$n_samples,
      qc$summary$n_outliers,
      round(qc$summary$mean_correlation, 3),
      paste0(round(qc$summary$pca_var_pc1, 1), "%")
    )
  )
  
  knitr::kable(summary_df, col.names = c("指标 / Metric", "值 / Value"))
}
```

# 样本统计 / Sample Statistics

```{r sample-stats}
if (!is.null(params$qc_results) && !is.null(params$qc_results$sample_stats)) {
  DT::datatable(
    params$qc_results$sample_stats,
    options = list(pageLength = 10, scrollX = TRUE),
    rownames = FALSE
  )
}
```

# 质控图表 / QC Plots

## 表达分布 / Expression Distribution

```{r boxplot, fig.width=12, fig.height=6}
if (!is.null(params$eset)) {
  expr <- exprs(params$eset)
  n_samples <- min(30, ncol(expr))
  
  par(mar = c(10, 4, 4, 2))
  boxplot(expr[, 1:n_samples], las = 2, col = rainbow(n_samples),
          main = "Expression Distribution / 表达分布",
          ylab = "Expression / 表达值")
}
```

## 样本相关性热图 / Correlation Heatmap

```{r correlation-heatmap, fig.width=10, fig.height=10}
if (!is.null(params$qc_results) && !is.null(params$qc_results$correlation_matrix)) {
  pheatmap(
    params$qc_results$correlation_matrix,
    color = colorRampPalette(c("blue", "white", "red"))(100),
    main = "Sample Correlation / 样本相关性",
    show_rownames = ncol(params$qc_results$correlation_matrix) <= 30,
    show_colnames = ncol(params$qc_results$correlation_matrix) <= 30
  )
}
```

## PCA分析 / PCA Analysis

```{r pca-plot, fig.width=10, fig.height=8}
if (!is.null(params$qc_results) && !is.null(params$qc_results$pca_results)) {
  pca_df <- data.frame(
    PC1 = params$qc_results$pca_results$scores[, 1],
    PC2 = params$qc_results$pca_results$scores[, 2],
    Sample = rownames(params$qc_results$pca_results$scores)
  )
  
  var_exp <- params$qc_results$pca_results$var_explained
  
  p <- ggplot(pca_df, aes(x = PC1, y = PC2, label = Sample)) +
    geom_point(size = 3, color = "steelblue") +
    geom_text(vjust = -0.5, size = 3) +
    theme_minimal() +
    labs(
      title = "PCA Plot / PCA图",
      x = paste0("PC1 (", round(var_exp[1], 1), "%)"),
      y = paste0("PC2 (", round(var_exp[2], 1), "%)")
    )
  
  print(p)
}
```

# 异常样本 / Outlier Samples

```{r outliers}
if (!is.null(params$qc_results) && !is.null(params$qc_results$outliers)) {
  outliers <- params$qc_results$outliers$all_outliers
  
  if (length(outliers) > 0) {
    cat("检测到以下异常样本 / Detected outlier samples:\n\n")
    for (s in outliers) {
      cat(paste0("- ", s, "\n"))
    }
  } else {
    cat("未检测到异常样本 / No outlier samples detected")
  }
}
```

# 质控建议 / QC Recommendations

```{r recommendations}
if (!is.null(params$qc_results) && !is.null(params$qc_results$summary$recommendations)) {
  recs <- params$qc_results$summary$recommendations
  
  for (rec in recs) {
    cat(paste0("- ", rec, "\n"))
  }
}
```

---

*Report generated by GEO-Analysis-Pipeline*
